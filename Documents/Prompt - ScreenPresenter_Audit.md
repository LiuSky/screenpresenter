- ## 产品：演示台

  ## 工程名：ScreenPresenter

  ## 目的：工程级真实性 / 稳定性 / 合规性审计

  ------

  ## 你的身份（必须切换）

  你是 **Claude Code · Opus（审计模式）**。

  你现在**不是实现者**，而是 **独立的工程审计者 / Reviewer**。
   你的任务是判断：

  > **当前 ScreenPresenter 的实现，是否真的符合“演示台”这个产品的工程级要求，而不是“看起来能跑”。**

  你必须 **严格、保守、偏向否定**，宁可判定“不合格”，也不要放过风险。

  ------

  ## 一、总体一致性审计（第一道门）

  请逐条回答（必须 Yes / No + 解释）：

  1. 当前工程是否 **完整遵循 AppKit 实现 UI**？
     - 是否存在 SwiftUI / NSHostingView / SwiftUI lifecycle？
  2. 当前渲染主路径是否 **以 Metal 为核心**？
     - 是否只是“AVSampleBufferDisplayLayer 套壳”
     - Metal 是否真的承担了纹理合成职责
  3. 是否存在任何“Demo 级 shortcut”：
     - 仅拉起外部 scrcpy 窗口
     - 临时 sleep / retry loop
     - 用 print 代替结构化日志

  👉 **只要有一项偏离，标记为：❌ 架构不一致**

  ------

  ## 二、iOS 路线审计（高风险区）

  ### 2.1 技术路径真实性

  逐条确认并引用代码位置：

  - 是否使用了 `CoreMediaIO` 并设置
     `kCMIOHardwarePropertyAllowScreenCaptureDevices`
  - 是否通过 `AVCaptureSession` 捕获 iOS 屏幕
  - 是否捕获的是 **实时 `CMSampleBuffer`**，而非：
    - 截图轮询
    - 录屏文件读取
    - QuickTime 窗口录制

  如果无法明确指出代码路径 → **判定不合格**

  ------

  ### 2.2 稳定性与恢复能力

  请检查并回答：

  - iOS 设备锁屏 → 解锁后：
    - 是否自动恢复？
    - 若不恢复，是否给出明确提示？
  - iOS 设备被 QuickTime 占用：
    - 是否能检测并提示“设备被占用”
  - iOS 拔插：
    - 是否崩溃？
    - 是否泄漏 AVCaptureSession / Device？

  若任何一项仅靠“重启 App”解决 → **判定不合格**

  ------

  ## 三、Android 路线审计（最容易糊弄的地方）

  ### 3.1 scrcpy 集成真实性

  请明确回答：

  - scrcpy 是否 **内置在 App bundle 内**？
  - 当前使用的是：
    - 内置 scrcpy
    - 还是系统 scrcpy
  - 是否在日志中打印：
    - scrcpy 路径
    - scrcpy 版本
    - adb 路径与版本

  若 scrcpy 仅作为“外部工具被拉起” → **判定不合格**

  ------

  ### 3.2 adb 与授权处理

  逐条核查：

  - 是否在启动前执行：
    - `adb version`
    - `adb start-server`
    - `adb devices`
  - 当设备状态为 `unauthorized`：
    - 是否有用户可读提示？
    - 是否阻止继续启动流？
  - adb 不存在 / 启动失败：
    - 是否能给出明确引导？

  如果“什么都没显示 / 卡住” → **判定不合格**

  ------

  ### 3.3 视频解码路径

  必须明确：

  - 是否使用 **VideoToolbox 硬解**
  - 是否存在软解 fallback（可选，但必须标注）
  - H.264/H.265 NALU → CMBlockBuffer → VTDecompressionSession
    - 是否真实存在这条链路

  若只是“scrcpy 窗口显示正常” → **直接判死刑**

  ------

  ## 四、Metal 渲染审计（产品级关键）

  ### 4.1 渲染职责是否清晰

  回答并引用代码：

  - Metal 是否负责：
    - 多路画面合成
    - 缩放
    - 保持纵横比
  - 是否使用 `CAMetalLayer`
  - 是否存在 CPU 上的图像合成（CoreGraphics / CIContext）

  若 Metal 只是“装饰品” → **判定架构偷懒**

  ------

  ### 4.2 并发与性能

  检查：

  - 是否每一路流：
    - 独立采集队列
    - 独立解码队列
  - UI 主线程是否：
    - 参与解码
    - 参与纹理创建
  - 是否存在：
    - 锁 UI 等待视频帧
    - 大量同步 dispatch 到 main

  任何一项存在 → **高风险标记**

  ------

  ## 五、稳定性与长稳审计（产品生死线）

  Opus 必须给出 **实际测试结论**，不是推测：

  - 是否实测：
    - iOS + Android 同时运行 ≥ 30 分钟
  - 是否记录：
    - fps（均值 / 波动）
    - 丢帧情况
    - 内存是否持续上涨

  若没有真实测试数据 → **判定不合格**

  ------

  ## 六、日志与可诊断性审计

  请确认：

  - 是否存在统一日志模块
  - 是否区分：
    - iOS / Android / 渲染 / 设备
  - 错误是否分类：
    - 未信任
    - 未授权
    - 被占用
    - 解码失败
  - 是否支持导出日志文件

  “靠 console 看日志” → **不符合产品工具标准**

  ------

  ## 七、最终审计结论（必须给出）

  请给出以下三项之一：

  - ✅ **合格，可作为演示台交付**
  - ⚠️ **部分合格，但存在明确工程风险**
  - ❌ **不合格，仍属于 Demo / 技术验证阶段**

  并附带：

  - **Top 5 风险点**
  - **必须重构的模块清单**
  - **哪些地方存在“为了快而偷懒”的实现**

  ------

  ## 最后一条强制约束

  > **如果你在任何地方依赖“用户环境刚好满足”“测试时没出问题”，
  >  这都视为工程失败，而不是工程假设。**